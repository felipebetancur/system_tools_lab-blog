---
import Heading from '@/components/Heading.astro';
import SkillCard from '@/components/SkillCard.astro';
import { buttonVariants } from '@/components/ui/button';
import type { LanguageCode } from '@/i18n/ui';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { Calendar, Dumbbell } from 'lucide-react';

import heroImage from '@/assets/portada_systemtoolslab.png';
import { Image } from 'astro:assets';
import FeaturedProjectPreview from '../components/FeaturedProjectPreview.astro';
import type { TranslatedProject, TranslatedSkill } from '../type';
import { BlogPostCard } from '@/features/blog';
import { EmptyState } from '@/components/empty-state';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import { useTranslations } from '@/i18n/ui';

export type Props = {
  lang: LanguageCode;
  projects: Array<TranslatedProject>;
  skills: Array<TranslatedSkill>;
  heroGreeting: string;
  heroSubtitlePart1: string;
  heroIntroduction: string;
  heroViewWorkButton: string;
  heroContactButton: string;
  imageNotAvailable: string;
  featuredBlogTitle: string;
  featuredProjectsDescription: string;
  mySkillsTitle: string;
  mySkillsDescription: string;
};

const {
  lang,
  projects,
  skills,
  heroGreeting,
  heroSubtitlePart1,
  heroIntroduction,
  heroViewWorkButton,
  heroContactButton,
  imageNotAvailable,
  featuredBlogTitle,
  featuredProjectsDescription,
  mySkillsTitle,
  mySkillsDescription,
} = Astro.props;

// Load latest blog posts for current locale to display in "last-articles" section
const blogEntries: Array<CollectionEntry<'blog'>> = await getCollection(
  'blog',
  ({ data, id }) => {
    return data.isDraft !== true && id.startsWith(`${lang}/`);
  }
);

const enrichedPosts = await Promise.all(
  blogEntries.map(async (postEntry: CollectionEntry<'blog'>) => {
    const { remarkPluginFrontmatter } = await render(postEntry);
    return {
      id: postEntry.id,
      slug: postEntry.id,
      collection: postEntry.collection,
      data: {
        ...postEntry.data,
        readingTimeMinutes: remarkPluginFrontmatter.readingTimeMinutes,
      },
    };
  })
);

enrichedPosts.sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

const t = useTranslations(lang, 'homePage');
const blogT = useTranslations(lang, 'blogPage');
---

<section class="py-12 md:py-16">
  <div class="grid md:grid-cols-2 gap-8 lg:gap-12 items-center">
    {/* Hero Image (Placeholder for now) */}
    <div class="md:text-center">
      <div
        class="w-full max-w-[600px] mx-auto bg-muted rounded-lg shadow-xl overflow-hidden"
      >
        <Image
          src={heroImage}
          alt={'User profile image'}
          width={600}
          height={368}
          densities={[1, 1.5, 2]}
          quality="high"
          class="w-full"
        />
      </div>
    </div>

    {/* Hero Text Column */}
    <div class="text-center md:text-left order-1 md:order-2">
      <h1
        class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tight mb-4"
      >
        {heroGreeting}
      </h1>
      <p class="text-2xl md:text-3xl font-medium text-muted-foreground mb-2">
        <span>{heroSubtitlePart1}</span>
        <span class="text-primary"></span>
      </p>
      <p
        class="text-lg text-muted-foreground mb-8"
        set:html={heroIntroduction}
      ></p>
      <div
        class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start"
      >
        <a
          href="/blog"
          class={buttonVariants({ variant: 'default', size: 'lg' })}
        >
          <Dumbbell className="mr-2 size-4" />
          {heroViewWorkButton}
        </a>
        <a
          href={getRelativeLocaleUrl(lang, '/contact')}
          class={buttonVariants({ variant: 'outline', size: 'lg' })}
        >
          <Calendar className="mr-2 size-4" />
          {heroContactButton}
        </a>
      </div>
    </div>
  </div>
</section>


{/* Last articles section */}
<section id="last-articles" class="py-12 md:py-16">
  <div class="container mx-auto px-4">
    <Heading title={featuredBlogTitle} description={featuredProjectsDescription} className="flex flex-col items-center" />

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
      {
        enrichedPosts.length > 0 ? (
          enrichedPosts.slice(0, 3).map((post) => (
            <BlogPostCard post={post as any} lang={lang} />
          ))
        ) : (
          <EmptyState title={blogT('noPostsFound') || 'No posts found'} id="no-posts-home" />
        )
      }
    </div>
  </div>
</section>